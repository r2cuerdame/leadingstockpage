<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>한국카본 (017960) - 종목 분석</title>
    
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- ApexCharts -->
    <script src="https://cdn.jsdelivr.net/npm/apexcharts"></script>
    
    <style>
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        .chart-container {
            background: white;
            border-radius: 15px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 3px 10px rgba(0,0,0,0.05);
        }
        
        .ai-score {
            font-size: 3rem;
            font-weight: bold;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container-fluid mt-4">
        <div class="row">
            <!-- 왼쪽 컬럼: 차트 및 기본 정보 -->
            <div class="col-lg-8">
                <!-- 통합 차트 섹션 -->
                <div class="card mb-4">
                    <div class="card-header bg-primary text-white">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <button onclick="history.back()" class="btn btn-sm btn-outline-light me-2" title="뒤로 가기">
                                    <i class="fas fa-arrow-left"></i>
                                </button>
                                <i class="fas fa-chart-line"></i> 한국카본 (017960) 차트
                            </h5>
                            <a href="https://finance.naver.com/item/main.nhn?code=017960" 
                               target="_blank" 
                               class="btn btn-light btn-sm">
                                <i class="fas fa-external-link-alt"></i> 네이버 금융
                            </a>
                        </div>
                    </div>
                    <div class="card-body">
                        <!-- 캔들스틱 차트 -->
                        <div id="stockChart" style="height: 450px;">
                            <div class="chart-loading text-center p-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">차트 로딩 중...</span>
                                </div>
                                <div class="mt-2 text-muted">1년 차트 데이터 로딩 중...</div>
                            </div>
                        </div>
                        
                        <!-- 거래량 차트 -->
                        <div id="volumeChart" style="height: 150px; margin-top: 20px;">
                            <div class="chart-loading text-center p-2">
                                <small class="text-muted">거래량 차트 로딩 중...</small>
                            </div>
                        </div>
                        
                        <!-- 차트 컨트롤 안내 -->
                        <div class="mt-3">
                            <small class="text-muted">
                                <i class="fas fa-info-circle"></i>
                                차트 조작: 마우스 휠(확대/축소), 드래그(이동), 하단 거래량 차트로 기간 선택
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- 오른쪽 컬럼: 분석 정보 -->
            <div class="col-lg-4">
                <!-- AI 분석 점수 -->
                <div class="card mb-4 border-primary">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0"><i class="fas fa-brain"></i> AI 분석 점수</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="ai-score">0.0</div>
                        <div class="text-muted">종합 점수</div>
                        <div class="mt-3">
                            <span class="badge bg-info fs-6">
                                등급: N/A
                            </span>
                        </div>
                    </div>
                </div>
                
                <!-- 가격 정보 -->
                <div class="card mb-4">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0"><i class="fas fa-won-sign"></i> 가격 정보</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-6">
                                <strong>현재가</strong><br>
                                <span class="text-primary fs-5">50,000원</span>
                            </div>
                            <div class="col-6">
                                <strong>목표가</strong><br>
                                <span class="text-success fs-5">62,500원</span>
                            </div>
                        </div>
                        <hr>
                        <div class="row">
                            <div class="col-6">
                                <strong>예상수익률</strong><br>
                                <span class="text-success">+25.0%</span>
                            </div>
                            <div class="col-6">
                                <strong>투자기간</strong><br>
                                <span class="text-info">30일</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- 분석 요약 -->
                <div class="card mb-4">
                    <div class="card-header bg-info text-white">
                        <h5 class="mb-0"><i class="fas fa-lightbulb"></i> 분석 요약</h5>
                    </div>
                    <div class="card-body">
                        <p class="card-text">
                            AI 분석결과 0.0점의 종목으로 평가됩니다.
                        </p>
                    </div>
                </div>
                
                <!-- 기술적 분석 -->
                <div class="card mb-4">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0"><i class="fas fa-chart-bar"></i> 기술적 분석</h5>
                    </div>
                    <div class="card-body">
                        <div class="mb-3">
                            <strong>차트 패턴:</strong><br>
                            <span class="text-primary">상승 삼각형</span>
                        </div>
                        <div class="mb-3">
                            <strong>기술적 신호:</strong><br>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-arrow-up text-success me-2"></i>RSI 과매도 구간</li><li><i class="fas fa-arrow-up text-success me-2"></i>볼린저 밴드 하단 터치</li>
                            </ul>
                        </div>
                        <div class="mb-3">
                            <strong>거래량 분석:</strong><br>
                            <span class="text-success">거래량 증가 추세</span>
                        </div>
                        <div class="mb-3">
                            <strong>주요 호재:</strong><br>
                            <ul class="list-unstyled">
                                <li><i class="fas fa-plus-circle text-success me-2"></i>실적 개선 기대</li><li><i class="fas fa-plus-circle text-success me-2"></i>신제품 출시</li>
                            </ul>
                        </div>
                        <div>
                            <strong>리스크 요인:</strong><br>
                            <ul class="list-unstyled text-danger">
                                <li><i class="fas fa-exclamation-triangle text-warning me-2"></i>원자재 가격 변동성</li><li><i class="fas fa-exclamation-triangle text-warning me-2"></i>글로벌 경기 둔화</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <script>
        
        // 1년 차트 데이터 생성 (현실적인 시뮬레이션)
        const generateChartData = () => {
            const data = [];
            const volumeData = [];
            let basePrice = 50000;
            
            // 1년 (252 거래일) 데이터 생성
            const totalDays = 252;
            
            // 시장 사이클 및 트렌드 시뮬레이션
            const trends = [
                { period: 60, direction: 'up', volatility: 0.02 },     // 상승 구간
                { period: 80, direction: 'sideways', volatility: 0.015 }, // 횡보 구간  
                { period: 70, direction: 'down', volatility: 0.025 },     // 하락 구간
                { period: 42, direction: 'recovery', volatility: 0.03 }   // 반등 구간
            ];
            
            let currentTrendIndex = 0;
            let daysInCurrentTrend = 0;
            
            for (let i = totalDays - 1; i >= 0; i--) {
                const date = new Date();
                date.setDate(date.getDate() - i);
                
                // 현재 트렌드 가져오기
                const currentTrend = trends[currentTrendIndex];
                
                // 트렌드별 가격 변동 계산
                let trendMultiplier = 0;
                switch(currentTrend.direction) {
                    case 'up':
                        trendMultiplier = 0.0005 + (Math.random() * 0.001);
                        break;
                    case 'down': 
                        trendMultiplier = -0.0008 - (Math.random() * 0.001);
                        break;
                    case 'recovery':
                        trendMultiplier = 0.0012 + (Math.random() * 0.002);
                        break;
                    default: // sideways
                        trendMultiplier = (Math.random() - 0.5) * 0.0002;
                }
                
                // 일일 변동성 (±2-3%)
                const dailyVariation = (Math.random() - 0.5) * currentTrend.volatility * 2;
                
                // 가격 계산
                const open = basePrice * (1 + trendMultiplier + dailyVariation);
                const closeVariation = (Math.random() - 0.5) * 0.02; // ±1% 추가 변동
                const close = open * (1 + closeVariation);
                
                // 고가/저가 계산 (더 현실적)
                const high = Math.max(open, close) * (1 + Math.random() * 0.01);
                const low = Math.min(open, close) * (1 - Math.random() * 0.01);
                
                data.push({
                    x: date.getTime(),
                    y: [
                        Math.round(open),
                        Math.round(high),
                        Math.round(low),
                        Math.round(close)
                    ]
                });
                
                // 거래량 시뮬레이션 (가격 변동과 상관관계 + 색상 정보)
                const baseVolume = 100000;
                const priceChangePercent = Math.abs((close - open) / open);
                const volumeMultiplier = 1 + (priceChangePercent * 3); // 가격 변동 클수록 거래량 증가
                const randomVolume = 0.5 + Math.random() * 1.5;
                const volume = Math.round(baseVolume * volumeMultiplier * randomVolume);
                
                // 상승/하락에 따른 거래량 색상 결정
                const isUp = close > open;
                const volumeColor = isUp ? '#EF5350' : '#2196F3';  // 상승: 빨강, 하락: 파랑
                
                volumeData.push({
                    x: date.getTime(),
                    y: volume,
                    fillColor: volumeColor
                });
                
                basePrice = close;
                daysInCurrentTrend++;
                
                // 트렌드 전환
                if (daysInCurrentTrend >= currentTrend.period && currentTrendIndex < trends.length - 1) {
                    currentTrendIndex++;
                    daysInCurrentTrend = 0;
                }
            }
            
            return { priceData: data, volumeData: volumeData };
        };
        
        const { priceData, volumeData } = generateChartData();
        
        // 캔들스틱 차트 (상단) - 1년 차트
        const candlestickOptions = {
            series: [{
                name: '한국카본',
                data: priceData
            }],
            chart: {
                type: 'candlestick',
                height: 450,  // 높이 증가
                id: 'candlesticks',
                toolbar: {
                    show: true,
                    autoSelected: 'pan',
                    tools: {
                        download: true,
                        selection: true,
                        zoom: true,
                        zoomin: true,
                        zoomout: true,
                        pan: true,
                        reset: true
                    }
                },
                zoom: {
                    enabled: true,
                    type: 'x',
                    autoScaleYaxis: true
                }
            },
            title: {
                text: '한국카본 (017960) - 1년 차트',
                align: 'left',
                style: {
                    fontSize: '16px',
                    fontWeight: 'bold',
                    color: '#333'
                }
            },
            xaxis: {
                type: 'datetime',
                labels: {
                    show: false  // 하단 차트에만 x축 라벨 표시
                },
                crosshairs: {
                    show: true
                }
            },
            yaxis: {
                title: {
                    text: '주가 (원)'
                },
                tooltip: {
                    enabled: true
                },
                labels: {
                    formatter: function(value) {
                        return value.toLocaleString() + '원';
                    }
                }
            },
            plotOptions: {
                candlestick: {
                    colors: {
                        upward: '#EF5350',    // 상승: 빨간색 (한국 표준)
                        downward: '#2196F3'   // 하락: 파란색 (한국 표준)
                    },
                    wick: {
                        useFillColor: true
                    }
                }
            },
            tooltip: {
                custom: function({ seriesIndex, dataPointIndex, w }) {
                    const data = w.globals.seriesCandleO[seriesIndex][dataPointIndex];
                    const open = data[0];
                    const high = data[1]; 
                    const low = data[2];
                    const close = data[3];
                    const date = new Date(w.globals.seriesX[seriesIndex][dataPointIndex]);
                    const changeAmount = close - open;
                    const changePercent = ((close - open) / open * 100).toFixed(2);
                    const changeColor = changeAmount >= 0 ? '#EF5350' : '#2196F3';
                    
                    return '<div class="apexcharts-tooltip-candlestick">' +
                        '<div>날짜: ' + date.toLocaleDateString('ko-KR') + '</div>' +
                        '<div>시가: ' + open.toLocaleString() + '원</div>' +
                        '<div>고가: ' + high.toLocaleString() + '원</div>' +
                        '<div>저가: ' + low.toLocaleString() + '원</div>' +
                        '<div>종가: ' + close.toLocaleString() + '원</div>' +
                        '<div style="color:' + changeColor + '">변동: ' + 
                        (changeAmount >= 0 ? '+' : '') + changeAmount.toLocaleString() + '원 (' + 
                        (changeAmount >= 0 ? '+' : '') + changePercent + '%)</div>' +
                        '</div>';
                }
            }
        };
        
        // 거래량 차트 (하단) - 개선된 동기화 및 동적 색상
        const volumeOptions = {
            series: [{
                name: '거래량',
                data: volumeData.map(item => item.y)  // y값만 추출
            }],
            chart: {
                type: 'bar',
                height: 150,  // 높이 증가
                brush: {
                    enabled: true,
                    target: 'candlesticks'
                },
                selection: {
                    enabled: true,
                    xaxis: {
                        min: priceData[0].x,  // 1년 전부터 (전체 데이터의 시작점)
                        max: priceData[priceData.length - 1].x  // 현재까지 (전체 데이터의 끝점)
                    }
                }
            },
            colors: volumeData.map(item => item.fillColor),  // 각 막대의 색상 배열
            plotOptions: {
                bar: {
                    distributed: true,  // 각 막대마다 다른 색상 적용
                    columnWidth: '80%'
                }
            },
            stroke: {
                width: 1
            },
            legend: {
                show: false  // 범례 숨김 (각 막대가 다른 색상이므로)
            },
            xaxis: {
                type: 'datetime',
                categories: volumeData.map(item => item.x),  // x축 카테고리 설정
                axisBorder: {
                    offsetX: 13
                },
                labels: {
                    datetimeUTC: false,
                    format: 'MM/dd'
                }
            },
            yaxis: {
                title: {
                    text: '거래량'
                },
                labels: {
                    show: true,
                    formatter: function(value) {
                        if (value >= 1000000) {
                            return (value / 1000000).toFixed(1) + 'M';
                        } else if (value >= 1000) {
                            return (value / 1000).toFixed(0) + 'K';
                        }
                        return value.toFixed(0);
                    }
                }
            },
            tooltip: {
                y: {
                    formatter: function(value) {
                        return value.toLocaleString() + '주';
                    }
                },
                custom: function({ seriesIndex, dataPointIndex, w }) {
                    const volume = w.globals.series[seriesIndex][dataPointIndex];
                    const date = new Date(volumeData[dataPointIndex].x);
                    
                    // 해당 날짜의 캔들 데이터 찾기
                    const candleData = priceData[dataPointIndex];
                    if (candleData) {
                        const open = candleData.y[0];
                        const close = candleData.y[3];
                        const isUp = close > open;
                        const colorText = isUp ? '상승' : '하락';
                        const colorStyle = isUp ? '#EF5350' : '#2196F3';
                        
                        return '<div class="apexcharts-tooltip-bar">' +
                            '<div>날짜: ' + date.toLocaleDateString('ko-KR') + '</div>' +
                            '<div>거래량: ' + volume.toLocaleString() + '주</div>' +
                            '<div style="color:' + colorStyle + '">구분: ' + colorText + ' 봉</div>' +
                            '</div>';
                    }
                    
                    return '<div class="apexcharts-tooltip-bar">' +
                        '<div>날짜: ' + date.toLocaleDateString('ko-KR') + '</div>' +
                        '<div>거래량: ' + volume.toLocaleString() + '주</div>' +
                        '</div>';
                }
            }
        };
        
        // 차트 렌더링
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // 차트 인스턴스 생성
                const candlestickChart = new ApexCharts(document.querySelector("#stockChart"), candlestickOptions);
                const volumeChart = new ApexCharts(document.querySelector("#volumeChart"), volumeOptions);
                
                // 캔들스틱 차트 먼저 렌더링
                candlestickChart.render().then(function() {
                    console.log('✅ 1년 캔들스틱 차트 렌더링 완료 (한국 색상: 상승=빨강, 하락=파랑)');
                    
                    // 그 다음 거래량 차트 렌더링
                    return volumeChart.render();
                }).then(function() {
                    console.log('✅ 거래량 차트 렌더링 완료 (동적 색상 적용)');
                    console.log('🔗 차트 동기화 설정 완료 (ApexCharts brush 기능)');
                    
                    // 차트 로딩 완료 표시
                    const loadingElements = document.querySelectorAll('.chart-loading');
                    loadingElements.forEach(el => el.style.display = 'none');
                    
                }).catch(function(error) {
                    console.error('❌ 차트 렌더링 오류:', error);
                    
                    // 오류 발생 시 기본 차트라도 표시
                    const stockChartEl = document.querySelector("#stockChart");
                    const volumeChartEl = document.querySelector("#volumeChart");
                    
                    if (stockChartEl) {
                        stockChartEl.innerHTML = '<div class="text-center p-4"><i class="fas fa-chart-line fa-3x text-muted"></i><br><span class="text-muted">차트 데이터 로딩 중...</span></div>';
                    }
                    if (volumeChartEl) {
                        volumeChartEl.innerHTML = '<div class="text-center p-2"><span class="text-muted">거래량 차트 로딩 중...</span></div>';
                    }
                });
                
            } catch(error) {
                console.error('❌ 차트 초기화 오류:', error);
            }
        });
    </script>
</body>
</html>
